<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test Progress Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#708096;
      --accent:#3b82f6;
      --success:#16a34a;
      --warning:#f97316;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.6);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    
    html,body{margin:0;padding:0;background:var(--bg);color:#0f172a;min-height:100vh;}
    
    .container{
      max-width:1200px;margin:28px auto;padding:20px;
    }
    .grid{
      display:grid;grid-template-columns:1fr;gap:20px;
    }
    @media(min-width:900px){
      .grid{grid-template-columns: 1fr 360px;align-items:start}
    }
    .main{
      display:grid;gap:20px;
    }
    .card{
      background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(12,20,30,0.06);
    }
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:700px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{padding:14px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.6),var(--card));display:flex;flex-direction:column}
    .kpi .label{font-size:13px;color:var(--muted)}
    .kpi .value{font-size:20px;font-weight:700;margin-top:6px}
    .kpi .delta{font-size:12px;color:var(--muted);margin-top:6px}
    .kpi .spark{height:36px !important;margin-top:10px;display:block;width:100% !important;max-height:36px !important}

    .charts{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:900px){.charts{grid-template-columns:1fr 1fr}}

    /* Table styles */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;text-align:left;font-size:14px}
    thead th{font-size:12px;color:var(--muted);font-weight:600}
    .status{
      display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600;color:#fff;font-size:12px
    }
    .status.on{background:var(--success)}
    .status.delayed{background:var(--warning)}
    .status.critical{background:var(--danger)}

    .progress-wrap{background:#eef2f7;border-radius:8px;overflow:hidden;height:10px;width:120px}
    .progress-bar{height:10px;background:linear-gradient(90deg,var(--accent),#60a5fa);}

    .aside{display:grid;gap:20px}
    .placeholder{display:flex;align-items:center;justify-content:center;height:220px;border:2px dashed rgba(15,23,42,0.06);color:var(--muted);font-weight:600;border-radius:8px;background:linear-gradient(180deg,rgba(240,246,255,0.6),transparent)}

    /* Fixed height chart containers - NO responsive height */
    .chart-wrapper{
      width: 100%;
      height: 250px;
      position: relative;
    }
    .chart-wrapper canvas {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    .footer-note{font-size:13px;color:var(--muted);text-align:center;padding:6px}
    .pill-toggle{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e6edf6;background:#fff;cursor:pointer;font-size:13px}
    .pill-toggle.active{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#fff;border-color:transparent}
    .pill-toggle .pill-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:rgba(0,0,0,0.06)}
    .pill-toggle.active .pill-badge{background:rgba(255,255,255,0.18)}
  </style>
</head>
<body>
  <div class="container">
    <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <h1 style="margin:0;font-size:20px">Test Progress Dashboard</h1>
      <div style="color:var(--muted);font-size:13px">Updated: <strong>Today</strong></div>
    </header>

    <div class="grid">
      <main class="main">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 style="margin:0;font-size:15px">KPIs <button class="card-edit" data-target="kpis" style="margin-left:8px;vertical-align:middle;border:0;background:transparent;cursor:pointer;color:var(--muted)">✎</button></h3>
          </div>
          <div class="kpis">
            <div class="kpi">
              <div class="label">Test Cases Executed</div>
              <div class="value" id="kpi-executed">72%</div>
              <div class="delta">+6% vs yesterday</div>
              <canvas class="spark" id="spark1"></canvas>
            </div>
            <div class="kpi">
              <div class="label">Test Cases Passed</div>
              <div class="value" id="kpi-passed">65%</div>
              <div class="delta">+4% vs yesterday</div>
              <canvas class="spark" id="spark2"></canvas>
            </div>
            <div class="kpi">
              <div class="label">Defects Open</div>
              <div class="value" id="kpi-defects">18</div>
              <div class="delta">3 high priority</div>
              <canvas class="spark" id="spark3"></canvas>
            </div>
            <div class="kpi">
              <div class="label">Delay vs Plan</div>
              <div class="value" id="kpi-delay">2 days</div>
              <div class="delta">Since last milestone</div>
              <canvas class="spark" id="spark4"></canvas>
            </div>
          </div>
        </section>

        <section class="card charts">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;grid-column:1 / -1">
            <h3 style="margin:0;font-size:15px">Charts <button class="card-edit" data-target="charts" style="margin-left:8px;vertical-align:middle;border:0;background:transparent;cursor:pointer;color:var(--muted)">✎</button></h3>
          </div>
          <div>
            <h3 style="margin:0 0 8px 0;font-size:15px">Progress vs Plan</h3>
            <div class="chart-wrapper"><canvas id="progressBar"></canvas></div>
          </div>

          <div>
            <h3 style="margin:0 0 8px 0;font-size:15px">Burndown Chart</h3>
            <div class="chart-wrapper"><canvas id="burndown"></canvas></div>
          </div>
        </section>

        <section class="card">
          <h3 style="margin:0 0 12px 0;font-size:15px">Milestone Heatmap <button class="card-edit" data-target="milestones" style="margin-left:8px;vertical-align:middle;border:0;background:transparent;cursor:pointer;color:var(--muted)">✎</button></h3>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>Milestone</th><th>Status</th><th>% Complete</th><th>Risk</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td>Test Design</td>
                  <td><span class="status on">On Track</span></td>
                  <td><div class="progress-wrap"><div class="progress-bar" style="width:92%"></div></div></td>
                  <td>Low</td>
                </tr>
                <tr>
                  <td>Test Execution</td>
                  <td><span class="status delayed">Delayed</span></td>
                  <td><div class="progress-wrap"><div class="progress-bar" style="width:68%"></div></div></td>
                  <td>Medium</td>
                </tr>
                <tr>
                  <td>UAT</td>
                  <td><span class="status critical">Critical</span></td>
                  <td><div class="progress-wrap"><div class="progress-bar" style="width:40%"></div></div></td>
                  <td>High</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>

      <aside class="aside">
        <div class="card">
          <h3 style="margin:0 0 10px 0;font-size:15px">Blockers Drill-Down <button class="card-edit" data-target="blockers" style="margin-left:8px;vertical-align:middle;border:0;background:transparent;cursor:pointer;color:var(--muted)">✎</button></h3>
          <div style="padding:8px" id="blockersList">
            <ul style="list-style:none;margin:0;padding:0;" id="blockersUl">
              <li style="margin-bottom:10px;display:flex;align-items:flex-start;gap:10px">
                <span class="status critical" style="min-width:72px">Critical</span>
                <div>
                  <div style="font-weight:600">API Integration Failures</div>
                  <div style="color:var(--muted);font-size:13px">Blocked by vendor bug — test runs failing on auth endpoint. Estimated fix: 2 days.</div>
                </div>
              </li>
              <li style="margin-bottom:10px;display:flex;align-items:flex-start;gap:10px">
                <span class="status delayed" style="min-width:72px">Delayed</span>
                <div>
                  <div style="font-weight:600">Test Environment Provisioning</div>
                  <div style="color:var(--muted);font-size:13px">Staging environment missing required DB snapshot. ETA: today evening.</div>
                </div>
              </li>
              <li style="margin-bottom:10px;display:flex;align-items:flex-start;gap:10px">
                <span class="status on" style="min-width:72px">On Track</span>
                <div>
                  <div style="font-weight:600">Test Data Refresh</div>
                  <div style="color:var(--muted);font-size:13px">Automated job scheduled and running as expected.</div>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 10px 0;font-size:15px">Quick Facts <button class="card-edit" data-target="quickfacts" style="margin-left:8px;vertical-align:middle;border:0;background:transparent;cursor:pointer;color:var(--muted)">✎</button></h3>
          <ul style="margin:0;padding-left:18px;color:var(--muted)" id="quickFactsList">
            <li>Active testers: <strong id="q-active">12</strong></li>
            <li>Avg execution/day: <strong id="q-exec">340</strong></li>
            <li>Open critical defects: <strong id="q-critical">3</strong></li>
          </ul>
        </div>
      </aside>
    </div>

    <div class="footer-note">Built with HTML, CSS Grid and Chart.js • Sample data only</div>
  </div>

  <!-- Export Button -->
  <button id="exportBtn" aria-label="Export" style="position:fixed;right:18px;bottom:18px;background:#111827;color:white;border:none;border-radius:999px;padding:12px 14px;box-shadow:0 6px 18px rgba(2,6,23,0.25);cursor:pointer;z-index:999">Export</button>
  <!-- keep modal editor triggers inside the editor modal UI -->

  <!-- Card edit popover -->
  <div id="cardEditPopover" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;padding:14px;box-shadow:0 12px 30px rgba(2,6,23,0.12);display:none;z-index:1001;width:420px;max-width:95%">
    <h4 id="cardEditTitle" style="margin:0 0 8px 0">Edit</h4>
    <div id="cardEditBody"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="cardSaveBtn" style="flex:1;padding:8px;background:var(--accent);color:#fff;border-radius:6px;border:none;cursor:pointer">Save</button>
      <button id="cardCancelBtn" style="flex:1;padding:8px;background:#f3f6fb;color:#234;border-radius:6px;border:1px solid #e6edf6;cursor:pointer">Cancel</button>
    </div>
  </div>

  <!-- Modal Editor -->
  <div id="editorModal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);align-items:center;justify-content:center;z-index:1000;padding:20px">
    <div style="background:#fff;border-radius:10px;max-width:900px;width:100%;max-height:90vh;overflow:auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Detailed Editor</h3>
        <button id="closeModalBtn" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
      </div>

      <section style="margin-bottom:12px">
        <h4 style="margin:0 0 8px 0">Progress vs Plan (per phase)</h4>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="progressExportCsv" style="padding:6px 8px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Export CSV</button>
          <button id="progressImportCsv" style="padding:6px 8px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Import CSV</button>
          <input type="file" id="progressCsvInput" accept="text/csv" style="display:none">
        </div>
        <table id="progressTable" style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">Phase</th><th>Planned %</th><th>Actual %</th></tr></thead>
          <tbody>
            <tr><td>Test Design</td><td><input class="p-planned" type="number" min="0" max="100" value="95" style="width:100px"></td><td><input class="p-actual" type="number" min="0" max="100" value="92" style="width:100px"></td></tr>
            <tr><td>Test Execution</td><td><input class="p-planned" type="number" min="0" max="100" value="85" style="width:100px"></td><td><input class="p-actual" type="number" min="0" max="100" value="68" style="width:100px"></td></tr>
            <tr><td>UAT</td><td><input class="p-planned" type="number" min="0" max="100" value="80" style="width:100px"></td><td><input class="p-actual" type="number" min="0" max="100" value="40" style="width:100px"></td></tr>
          </tbody>
        </table>
      </section>

      <section>
        <h4 style="margin:0 0 8px 0">Burndown (time series)</h4>
        <div style="margin-bottom:8px;display:flex;gap:12px;align-items:center">
          <div style="color:var(--muted);font-size:13px">Today: <strong id="todayLabel"></strong></div>
          <button id="addRowBtn" style="padding:6px 8px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Add Row</button>
          <button id="burndownExportCsv" style="padding:6px 8px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Export CSV</button>
          <button id="burndownImportCsv" style="padding:6px 8px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Import CSV</button>
          <input type="file" id="burndownCsvInput" accept="text/csv" style="display:none">
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
          <label style="display:flex;gap:6px;align-items:center;font-size:13px">Start Date: <input id="burndownStartDate" type="date" style="padding:6px"></label>
          <label style="display:flex;gap:6px;align-items:center;font-size:13px">Span: 
            <select id="burndownSpan" style="padding:6px">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="fortnightly">Fortnightly</option>
              <option value="monthly">Monthly</option>
            </select>
          </label>
          <button id="toggleAutoFill" type="button" class="pill-toggle" aria-pressed="false">Auto-fill <span class="pill-badge">OFF</span></button>
          <div id="autoFillPanel" style="display:none;margin-left:8px;align-items:center;gap:8px">
            <label style="display:flex;gap:6px;align-items:center;font-size:13px">From<input id="plannedStart" type="number" value="1000" style="width:80px;padding:6px"></label>
            <label style="display:flex;gap:6px;align-items:center;font-size:13px">To<input id="plannedEnd" type="number" value="0" style="width:80px;padding:6px"></label>
          </div>
          <div style="margin-left:auto"></div>
          <button id="generateSeriesBtn" style="padding:6px 8px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Generate Series</button>
        </div>
        <table id="burndownTable" style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">Date</th><th>Planned Remaining</th><th>Actual Remaining</th><th></th></tr></thead>
          <tbody>
            <tr><td><input class="b-date" type="text" value="2025-11-01" style="width:160px"></td><td><input class="b-planned" type="number" value="1000" style="width:120px"></td><td><input class="b-actual" type="number" value="1000" style="width:120px"></td><td><button class="removeRow" style="border:none;background:transparent;cursor:pointer">Remove</button></td></tr>
            <tr><td><input class="b-date" type="text" value="2025-11-04" style="width:160px"></td><td><input class="b-planned" type="number" value="800" style="width:120px"></td><td><input class="b-actual" type="number" value="920" style="width:120px"></td><td><button class="removeRow" style="border:none;background:transparent;cursor:pointer">Remove</button></td></tr>
            <tr><td><input class="b-date" type="text" value="2025-11-07" style="width:160px"></td><td><input class="b-planned" type="number" value="600" style="width:120px"></td><td><input class="b-actual" type="number" value="780" style="width:120px"></td><td><button class="removeRow" style="border:none;background:transparent;cursor:pointer">Remove</button></td></tr>
          </tbody>
        </table>
      </section>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="modalSave" style="flex:1;padding:8px;background:var(--accent);color:#fff;border-radius:6px;border:none;cursor:pointer">Save</button>
        <button id="modalExport" style="flex:1;padding:8px;background:#111827;color:#fff;border-radius:6px;border:none;cursor:pointer">Export Snapshot</button>
        <button id="modalCancel" style="flex:1;padding:8px;background:#f3f6fb;color:#234;border-radius:6px;border:1px solid #e6edf6;cursor:pointer">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Sparklines
    // Sample small sparks
    function drawSpark(id, data, color){
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      // create non-responsive tiny chart so Chart.js doesn't resize the page
      const chart = new Chart(ctx, {
        type: 'line',
        data: {labels:data.map((_,i)=>i), datasets:[{data:data,borderColor:color,backgroundColor:'transparent',tension:0.4,pointRadius:0}]},
        options:{
          plugins:{legend:{display:false}},
          scales:{x:{display:false},y:{display:false}},
          elements:{line:{borderWidth:2}},
          responsive:false,
          maintainAspectRatio:false
        }
      });

      // Ensure display size is small and remove any large inline attributes Chart.js may have set
      try{
        canvas.style.height = '36px';
        canvas.style.maxHeight = '36px';
        canvas.style.width = '100%';
        canvas.removeAttribute('height');
        canvas.removeAttribute('width');
      }catch(e){/* ignore */}
      return chart;
    }

    drawSpark('spark1',[10,30,45,55,62,72],'#3b82f6');
    drawSpark('spark2',[8,20,30,42,58,65],'#10b981');
    drawSpark('spark3',[20,22,21,19,18,18],'#ef4444');
    drawSpark('spark4',[0,0,1,1,2,2],'#f97316');

    // Progress vs Plan Bar Chart
    const progCtx = document.getElementById('progressBar').getContext('2d');
    const progressChart = new Chart(progCtx, {
      type: 'bar',
      data: {
        labels: ['Test Design','Test Execution','UAT'],
        datasets: [
          {label:'Planned %',data:[95,85,80],backgroundColor:'rgba(99,102,241,0.9)'},
          {label:'Actual %',data:[92,68,40],backgroundColor:'rgba(59,130,246,0.8)'}
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{position:'bottom'}},
        scales:{y:{beginAtZero:true,max:100}}
      }
    });
    // remove any inline attributes Chart.js might set
    try{ const pCan = document.getElementById('progressBar'); pCan.removeAttribute('height'); pCan.removeAttribute('width'); }catch(e){}

    // Burndown Chart
    const burndownCtx = document.getElementById('burndown').getContext('2d');
    const burndownChart = new Chart(burndownCtx, {
      type: 'line',
      data: {
        labels: ['Day 0','Day 3','Day 6','Day 9','Day 12','Day 15'],
        datasets:[
          {label:'Planned Remaining',data:[1000,800,600,400,200,0],borderColor:'rgba(99,102,241,0.9)',backgroundColor:'rgba(99,102,241,0.06)',tension:0.3,fill:true},
          {label:'Actual Remaining',data:[1000,920,780,680,520,300],borderColor:'rgba(255,99,132,0.9)',backgroundColor:'rgba(255,99,132,0.06)',tension:0.3,fill:true}
        ]
      },
      options:{
        responsive:false,
        maintainAspectRatio:false,
        plugins:{legend:{position:'bottom'}},
        scales:{
          x: {
            ticks: {
              callback: function(value, index, ticks){
                try{
                  const label = this.chart.data.labels[index];
                  if(/^\d{4}-\d{2}-\d{2}$/.test(label)){
                    const d = new Date(label + 'T00:00:00');
                    return new Intl.DateTimeFormat(navigator.language||'en-US',{month:'short',day:'numeric'}).format(d);
                  }
                  return label;
                }catch(e){ return value; }
              }
            }
          },
          y:{beginAtZero:true}
        }
      }
    });
    try{ const bCan = document.getElementById('burndown'); bCan.removeAttribute('height'); bCan.removeAttribute('width'); }catch(e){}
  </script>
  <script>
    // Popover behaviour
    // small popover removed — KPIs now edited via centered card popover
    
    // Modal editor handlers
    const editorModal = document.getElementById('editorModal');
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');
    const modalExport = document.getElementById('modalExport');
    const exportQuickBtn = document.getElementById('exportQuickBtn');

    if(openModalBtn) openModalBtn.addEventListener('click', ()=>{ editorModal.style.display='flex'; populateModal(); });
    if(closeModalBtn) closeModalBtn.addEventListener('click', ()=>{ editorModal.style.display='none'; });
    if(modalCancel) modalCancel.addEventListener('click', ()=>{ editorModal.style.display='none'; });

    // Add/remove burndown rows
    const addRowBtn = document.getElementById('addRowBtn');
    if(addRowBtn) addRowBtn.addEventListener('click', ()=>{
      const tbody = document.querySelector('#burndownTable tbody');
      const tr = document.createElement('tr');
      // new rows default to empty ISO date (user can pick)
      tr.innerHTML = `<td><input class="b-date" type="date" value="" style="width:160px"></td><td><input class="b-planned" type="number" value="0" style="width:120px"></td><td><input class="b-actual" type="number" value="0" style="width:120px"></td><td><button class="removeRow" style="border:none;background:transparent;cursor:pointer">Remove</button></td>`;
      tbody.appendChild(tr);
    });
    document.addEventListener('click', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('removeRow')) e.target.closest('tr').remove(); });

    // Series generator helpers
    function toIsoDate(d){ return d.toISOString().slice(0,10); }
    function addDays(d, n){ const r = new Date(d); r.setDate(r.getDate() + n); return r; }
    function addMonths(d, n){ const r = new Date(d); r.setMonth(r.getMonth() + n); return r; }
    function computeSeries(startIso, span){
      if(!startIso) return [];
      const start = new Date(startIso + 'T00:00:00');
      const today = new Date();
      const out = [];
      let cur = new Date(start);
      const stepDays = (s)=> s==='daily'?1:s==='weekly'?7:s==='fortnightly'?14:0;
      if(span === 'monthly'){
        while(cur <= today){ out.push(toIsoDate(cur)); cur = addMonths(cur,1); }
      } else {
        const step = stepDays(span) || 1;
        while(cur <= today){ out.push(toIsoDate(cur)); cur = addDays(cur, step); }
      }
      return out;
    }

    // wire generate button
    const generateBtn = document.getElementById('generateSeriesBtn');
    const startInput = document.getElementById('burndownStartDate');
    const spanSelect = document.getElementById('burndownSpan');
    const todayLabel = document.getElementById('todayLabel');
    const plannedStartInput = document.getElementById('plannedStart');
    const plannedEndInput = document.getElementById('plannedEnd');
    if(todayLabel) todayLabel.textContent = new Date().toISOString().slice(0,10);
    if(generateBtn){
      generateBtn.addEventListener('click', ()=>{
        const start = startInput.value;
        const span = spanSelect.value;
        if(!start){ alert('Please choose a start date'); return; }
        const series = computeSeries(start, span);
        const tbody = document.querySelector('#burndownTable tbody'); tbody.innerHTML = '';
        series.forEach(diso=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td></td><td><input class="b-planned" type="number" value="0" style="width:120px"></td><td><input class="b-actual" type="number" value="0" style="width:120px"></td><td><button class="removeRow" style="border:none;background:transparent;cursor:pointer">Remove</button></td>`;
          const dateCell = tr.querySelector('td');
          const input = document.createElement('input'); input.className='b-date'; input.type='date'; input.value = diso; input.setAttribute('data-iso', diso);
          const labelSpan = document.createElement('span'); labelSpan.className='b-date-label'; labelSpan.style.marginLeft='8px'; labelSpan.textContent = new Intl.DateTimeFormat(navigator.language||'en-US',{month:'short',day:'numeric'}).format(new Date(diso+'T00:00:00'));
          input.addEventListener('input',(e)=>{ const v=e.target.value.trim(); if(/^\d{4}-\d{2}-\d{2}$/.test(v)){ e.target.setAttribute('data-iso',v); labelSpan.textContent = new Intl.DateTimeFormat(navigator.language||'en-US',{month:'short',day:'numeric'}).format(new Date(v+'T00:00:00')); } else { e.target.removeAttribute('data-iso'); labelSpan.textContent = v; } });
          dateCell.appendChild(input); dateCell.appendChild(labelSpan);
          tbody.appendChild(tr);
        });
        // if auto-fill panel is visible, compute linear ramp for planned values
        try{
          const autoVisible = document.getElementById('autoFillPanel')?.style.display !== 'none';
          if(autoVisible){
            const from = Number(plannedStartInput.value||0);
            const to = Number(plannedEndInput.value||0);
            const rows = Array.from(document.querySelectorAll('#burndownTable tbody tr'));
            const n = rows.length;
            rows.forEach((r,i)=>{
              const v = Math.round(from + (to - from) * (i/(Math.max(1,n-1))));
              const inp = r.querySelector('.b-planned'); if(inp) inp.value = v;
            });
          }
        }catch(e){}
      });
    }
    // collapse/expand auto-fill panel
    const toggleAutoBtn = document.getElementById('toggleAutoFill');
    const autoFillPanel = document.getElementById('autoFillPanel');
    if(toggleAutoBtn && autoFillPanel){
      const badge = toggleAutoBtn.querySelector('.pill-badge');
      toggleAutoBtn.addEventListener('click', ()=>{
        const open = autoFillPanel.style.display !== 'none';
        autoFillPanel.style.display = open ? 'none' : 'flex';
        toggleAutoBtn.setAttribute('aria-pressed', String(!open));
        toggleAutoBtn.classList.toggle('active', !open);
        if(badge) badge.textContent = open ? 'OFF' : 'ON';
      });
    }

    function populateModal(){
      // progress: set inputs from current chart
      const planned = progressChart.data.datasets[0].data;
      const actual = progressChart.data.datasets[1].data;
      const pPlanned = document.querySelectorAll('.p-planned');
      const pActual = document.querySelectorAll('.p-actual');
      pPlanned.forEach((inp,i)=>inp.value = planned[i] || 0);
      pActual.forEach((inp,i)=>inp.value = actual[i] || 0);
      // burndown: clear tbody and fill from burndownChart
      const bTbody = document.querySelector('#burndownTable tbody');
      bTbody.innerHTML = '';
      const labels = burndownChart.data.labels || [];
      const pData = burndownChart.data.datasets[0].data || [];
      const aData = burndownChart.data.datasets[1].data || [];
      const locale = navigator.language || 'en-US';
      function isIso(s){ return typeof s==='string' && /^\d{4}-\d{2}-\d{2}$/.test(s); }
      function isoToDisplay(iso){ try{ const d = new Date(iso+'T00:00:00'); return new Intl.DateTimeFormat(locale,{month:'short',day:'numeric'}).format(d);}catch(e){return iso;} }
      for(let i=0;i<labels.length;i++){
        const row = document.createElement('tr');
        const labelVal = labels[i] || '';
        const useDate = isIso(labelVal);
        row.innerHTML = `<td></td><td><input class="b-planned" type="number" value="${pData[i]||0}" style="width:120px"></td><td><input class="b-actual" type="number" value="${aData[i]||0}" style="width:120px"></td><td><button class="removeRow" style="border:none;background:transparent;cursor:pointer">Remove</button></td>`;
        const dateCell = row.querySelector('td');
        const input = document.createElement('input'); input.className='b-date';
        if(useDate){ input.type='date'; input.value = labelVal; input.setAttribute('data-iso', labelVal); }
        else { input.type='text'; input.value = labelVal; }
        const labelSpan = document.createElement('span'); labelSpan.className='b-date-label'; labelSpan.style.marginLeft='8px'; labelSpan.textContent = useDate ? isoToDisplay(labelVal) : labelVal;
        input.addEventListener('input',(e)=>{
          const v = e.target.value.trim();
          if(isIso(v)){ e.target.type='date'; e.target.setAttribute('data-iso',v); labelSpan.textContent = isoToDisplay(v); }
          else { e.target.type='text'; e.target.removeAttribute('data-iso'); labelSpan.textContent = v; }
        });
        dateCell.appendChild(input); dateCell.appendChild(labelSpan);
        bTbody.appendChild(row);
      }
      // set sensible defaults for start date and span
      try{
        const isoLabels = labels.filter(l=>/^\d{4}-\d{2}-\d{2}$/.test(l));
        if(isoLabels.length>0){
          startInput.value = isoLabels[0];
          // try to guess span by average delta in days
          if(isoLabels.length>1){
            const d0 = new Date(isoLabels[0]+'T00:00:00'); const d1 = new Date(isoLabels[1]+'T00:00:00');
            const delta = Math.round((d1 - d0)/(24*3600*1000));
            if(delta<=1) spanSelect.value='daily'; else if(delta<=8) spanSelect.value='weekly'; else if(delta<=15) spanSelect.value='fortnightly'; else spanSelect.value='monthly';
          } else { spanSelect.value='weekly'; }
        } else {
          // default to 30 days ago
          const d = new Date(); d.setDate(d.getDate()-30); startInput.value = d.toISOString().slice(0,10);
          spanSelect.value = 'weekly';
        }
      }catch(e){}
    }

    function readBurndownTable(){
      const rows = Array.from(document.querySelectorAll('#burndownTable tbody tr'));
      const labels = rows.map(r=>{
        const inp = r.querySelector('.b-date');
        if(!inp) return '';
        // prefer canonical ISO stored in data-iso attribute
        if(inp.getAttribute && inp.getAttribute('data-iso')) return inp.getAttribute('data-iso');
        return inp.value || '';
      });
      const planned = rows.map(r=>Number(r.querySelector('.b-planned').value || 0));
      const actual = rows.map(r=>Number(r.querySelector('.b-actual').value || 0));
      return {labels,planned,actual};
    }

    // Persistence: save/load to localStorage
    const STORAGE_KEY = 'dashboard_demo_state_v1';
    function saveState(){
      // collect blockers
      const blockers = Array.from(document.querySelectorAll('#blockersUl li')).map(li=>({
        status: li.querySelector('.status')?.textContent.trim() || '',
        title: li.querySelector('div > div:first-child')?.textContent.trim() || '',
        note: li.querySelector('div > div:last-child')?.textContent.trim() || ''
      }));

      const state = {
        kpis: {
          executed: document.getElementById('kpi-executed').textContent.replace('%','')||0,
          passed: document.getElementById('kpi-passed').textContent.replace('%','')||0,
          defects: document.getElementById('kpi-defects').textContent||0,
          delay: document.getElementById('kpi-delay').textContent.replace(' days','')||0
        },
        progress: {
          planned: progressChart.data.datasets[0].data,
          actual: progressChart.data.datasets[1].data
        },
        burndown: {
          labels: burndownChart.data.labels,
          planned: burndownChart.data.datasets[0].data,
          actual: burndownChart.data.datasets[1].data
        },
        blockers,
        quickFacts: {
          active: document.getElementById('q-active').textContent || '0',
          exec: document.getElementById('q-exec').textContent || '0',
          critical: document.getElementById('q-critical').textContent || '0'
        }
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const state = JSON.parse(raw);
        if(state.kpis){
          document.getElementById('kpi-executed').textContent = (state.kpis.executed||0) + '%';
          document.getElementById('kpi-passed').textContent = (state.kpis.passed||0) + '%';
          document.getElementById('kpi-defects').textContent = state.kpis.defects||0;
          document.getElementById('kpi-delay').textContent = (state.kpis.delay||0) + ' days';
        }
        if(state.progress){
          progressChart.data.datasets[0].data = state.progress.planned || progressChart.data.datasets[0].data;
          progressChart.data.datasets[1].data = state.progress.actual || progressChart.data.datasets[1].data;
          progressChart.update();
        }
        if(state.burndown){
          burndownChart.data.labels = state.burndown.labels || burndownChart.data.labels;
          burndownChart.data.datasets[0].data = state.burndown.planned || burndownChart.data.datasets[0].data;
          burndownChart.data.datasets[1].data = state.burndown.actual || burndownChart.data.datasets[1].data;
          burndownChart.update();
        }
        // restore blockers and quick facts if present
        if(state.blockers){
          const ul = document.getElementById('blockersUl'); ul.innerHTML = '';
          state.blockers.forEach(b=>{
            const li = document.createElement('li'); li.style.marginBottom='10px'; li.style.display='flex'; li.style.alignItems='flex-start'; li.style.gap='10px';
            const span = document.createElement('span'); span.className = 'status ' + (b.status==='On Track'?'on':b.status==='Delayed'?'delayed':'critical'); span.style.minWidth='72px'; span.textContent = b.status;
            const div = document.createElement('div'); div.innerHTML = `<div style="font-weight:600">${b.title}</div><div style="color:var(--muted);font-size:13px">${b.note}</div>`;
            li.appendChild(span); li.appendChild(div); ul.appendChild(li);
          });
        }
        if(state.quickFacts){
          document.getElementById('q-active').textContent = state.quickFacts.active || '0';
          document.getElementById('q-exec').textContent = state.quickFacts.exec || '0';
          document.getElementById('q-critical').textContent = state.quickFacts.critical || '0';
        }
      }catch(e){console.warn('loadState error',e)}
    }
    // load on start
    loadState();

    // Save to localStorage on chart updates and KPI changes
    const origProgressUpdate = progressChart.update.bind(progressChart);
    progressChart.update = function(){ origProgressUpdate(); saveState(); };
    const origBurndownUpdate = burndownChart.update.bind(burndownChart);
    burndownChart.update = function(){ origBurndownUpdate(); saveState(); };

    // Also save when KPI values change via the popover save (no small popover exists now)


    modalSave.addEventListener('click', ()=>{
      // apply progress table
      const pPlanned = Array.from(document.querySelectorAll('.p-planned')).map(i=>Number(i.value||0));
      const pActual = Array.from(document.querySelectorAll('.p-actual')).map(i=>Number(i.value||0));
      progressChart.data.datasets[0].data = pPlanned;
      progressChart.data.datasets[1].data = pActual;
      progressChart.update();
      // update milestone bars
      document.querySelectorAll('.progress-bar')[0].style.width = pActual[0] + '%';
      document.querySelectorAll('.progress-bar')[1].style.width = pActual[1] + '%';
      document.querySelectorAll('.progress-bar')[2].style.width = pActual[2] + '%';

      // apply burndown
      const bd = readBurndownTable();
      burndownChart.data.labels = bd.labels;
      burndownChart.data.datasets[0].data = bd.planned;
      burndownChart.data.datasets[1].data = bd.actual;
      burndownChart.update();

      editorModal.style.display = 'none';
    });

    function generateSnapshot(){
      // Create a clone of document HTML and strip edit elements
      const docClone = document.documentElement.cloneNode(true);
      // remove edit button, popover and modal
      const removeSelectors = ['#editBtn','#editPopover','#editorModal'];
      removeSelectors.forEach(sel=>{ const el = docClone.querySelector(sel); if(el) el.remove(); });
      // also remove any scripts that include 'Chart' to avoid runtime errors — but embed chart images by converting canvases to dataURL
      // convert canvases to images
      const canvases = Array.from(document.querySelectorAll('canvas'));
      canvases.forEach((c)=>{
        const data = c.toDataURL('image/png');
        const img = document.createElement('img'); img.src = data; img.style.maxWidth='100%';
        const parent = c.parentElement;
        parent.replaceChild(img, c);
      });
      // build HTML string
      const html = '<!doctype html>\n' + docClone.outerHTML;
      return html;
    }

    function downloadSnapshot(){
      const html = generateSnapshot();
      const blob = new Blob([html], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const today = new Date().toISOString().slice(0,10);
      a.href = url; a.download = `dashboard_snapshot_${today}.html`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    if(modalExport) modalExport.addEventListener('click', downloadSnapshot);
    if(exportQuickBtn) exportQuickBtn.addEventListener('click', downloadSnapshot);

    // Wire the floating export button to the enhanced snapshot exporter
    const exportBtn = document.getElementById('exportBtn');
    if(exportBtn){ exportBtn.addEventListener('click', downloadSnapshotEnhanced); }

    // CSV helpers
    function arrayToCsv(rows){ return rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); }
    function downloadCsv(filename, content){ const blob = new Blob([content], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url); }

    // Progress CSV export/import
    document.getElementById('progressExportCsv').addEventListener('click', ()=>{
      const rows = [['Phase','Planned','Actual']];
      const phases = ['Test Design','Test Execution','UAT'];
      const planned = progressChart.data.datasets[0].data;
      const actual = progressChart.data.datasets[1].data;
      for(let i=0;i<phases.length;i++) rows.push([phases[i],planned[i]||'',actual[i]||'']);
      downloadCsv('progress.csv', arrayToCsv(rows));
    });
    document.getElementById('progressImportCsv').addEventListener('click', ()=>{ document.getElementById('progressCsvInput').click(); });
    document.getElementById('progressCsvInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{
        const lines = r.result.split(/\r?\n/).filter(Boolean).map(l=>l.split(/, */));
        // assume header + three rows
        if(lines.length>=4){
          const p=[]; const a=[];
          for(let i=1;i<lines.length;i++){ p.push(Number(lines[i][1]||0)); a.push(Number(lines[i][2]||0)); }
          progressChart.data.datasets[0].data = p; progressChart.data.datasets[1].data = a; progressChart.update();
        }
      }; r.readAsText(f);
    });

    // Burndown CSV export/import
    document.getElementById('burndownExportCsv').addEventListener('click', ()=>{
      const rows = [['Date','Planned','Actual']];
      const labels = burndownChart.data.labels || [];
      const p = burndownChart.data.datasets[0].data || [];
      const a = burndownChart.data.datasets[1].data || [];
      for(let i=0;i<labels.length;i++) rows.push([labels[i]||'',p[i]||'',a[i]||'']);
      downloadCsv('burndown.csv', arrayToCsv(rows));
    });
    document.getElementById('burndownImportCsv').addEventListener('click', ()=>{ document.getElementById('burndownCsvInput').click(); });
    document.getElementById('burndownCsvInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{
        const lines = r.result.split(/\r?\n/).filter(Boolean).map(l=>l.split(/, */));
        if(lines.length>=2){
          const labels=[]; const p=[]; const a=[];
          for(let i=1;i<lines.length;i++){
            const raw = (lines[i][0]||'').trim();
            labels.push(raw);
            p.push(Number(lines[i][1]||0));
            a.push(Number(lines[i][2]||0));
          }
          burndownChart.data.labels = labels;
          burndownChart.data.datasets[0].data = p;
          burndownChart.data.datasets[1].data = a;
          burndownChart.update();
        }
      }; r.readAsText(f);
    });

    // Enhanced snapshot export: inline Google Fonts CSS by fetching font file and encoding as base64
    async function inlineFontsAndGenerate(){
      // fetch the CSS for the Inter font we use
      const cssUrl = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap';
      const cssRes = await fetch(cssUrl); const cssText = await cssRes.text();
      // find font URLs and inline them (simple approach)
      const urls = Array.from(cssText.matchAll(/url\((https:\/\/[^)]+)\)/g)).map(m=>m[1]);
      let inlinedCss = cssText;
      for(const u of urls){
        try{
          const res = await fetch(u); const buf = await res.arrayBuffer(); const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
          const mime = res.headers.get('content-type') || 'font/woff2';
          inlinedCss = inlinedCss.replace(new RegExp(u.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&'),'g'), `data:${mime};base64,${b64}`);
        }catch(e){console.warn('font inline failed',e)}
      }
      const fontStyle = `<style>${inlinedCss}</style>`;
      // generate snapshot HTML string
      const docClone = document.documentElement.cloneNode(true);
      ['#editBtn','#editPopover','#editorModal','#progressCsvInput','#burndownCsvInput'].forEach(sel=>{ const el = docClone.querySelector(sel); if(el) el.remove(); });
      // convert canvases to images (use originals from live DOM)
      const canvases = Array.from(document.querySelectorAll('canvas'));
      canvases.forEach((c)=>{
        const data = c.toDataURL('image/png');
        const img = document.createElement('img'); img.src = data; img.style.maxWidth='100%';
        const parent = c.parentElement;
        // replace in the clone
        const selector = c.id ? `#${c.id}` : null;
        const cloneCanvas = selector ? docClone.querySelector(selector) : null;
        if(cloneCanvas && cloneCanvas.parentElement) cloneCanvas.parentElement.replaceChild(img.cloneNode(true), cloneCanvas);
      });
      // inject inlined font CSS into head
      const head = docClone.querySelector('head'); if(head) head.insertAdjacentHTML('beforeend', fontStyle);
      return '<!doctype html>\n' + docClone.outerHTML;
    }

    async function downloadSnapshotEnhanced(){
      const html = await inlineFontsAndGenerate();
      const blob = new Blob([html], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const today = new Date().toISOString().slice(0,10);
      a.href = url; a.download = `dashboard_snapshot_${today}.html`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    if(modalExport){ modalExport.removeEventListener('click', downloadSnapshot); modalExport.addEventListener('click', downloadSnapshotEnhanced); }
    if(exportQuickBtn){ exportQuickBtn.removeEventListener('click', downloadSnapshot); exportQuickBtn.addEventListener('click', downloadSnapshotEnhanced); }

    // Card edit handlers (Blockers and Quick Facts)
    (function(){
      const cardEditButtons = document.querySelectorAll('.card-edit');
      const cardPopover = document.getElementById('cardEditPopover');
      const cardEditTitle = document.getElementById('cardEditTitle');
      const cardEditBody = document.getElementById('cardEditBody');
      const cardSaveBtn = document.getElementById('cardSaveBtn');
      const cardCancelBtn = document.getElementById('cardCancelBtn');
      let currentCard = null;

      // focus trap helpers for centered card popover
      let lastFocusedElement = null;
      function trapKeydown(e){
        if(!cardPopover || cardPopover.style.display!=='block') return;
        if(e.key === 'Escape') { e.preventDefault(); closeCardPopover(); return; }
        if(e.key !== 'Tab') return;
        const focusable = Array.from(cardPopover.querySelectorAll('a[href],button:not([disabled]),textarea, input, select')).filter(el=>el.offsetParent !== null);
        if(focusable.length===0) return;
        const first = focusable[0]; const last = focusable[focusable.length-1];
        if(e.shiftKey){ if(document.activeElement === first){ e.preventDefault(); last.focus(); } }
        else { if(document.activeElement === last){ e.preventDefault(); first.focus(); } }
      }
      function openCardPopover(){ lastFocusedElement = document.activeElement; cardPopover.style.display='block'; const firstFocusable = cardEditBody.querySelector('input,select,textarea,button'); if(firstFocusable) firstFocusable.focus(); document.addEventListener('keydown', trapKeydown); }
      function closeCardPopover(){ cardPopover.style.display='none'; document.removeEventListener('keydown', trapKeydown); if(lastFocusedElement && lastFocusedElement.focus) lastFocusedElement.focus(); }

      cardEditButtons.forEach(b=>b.addEventListener('click', (e)=>{
        const target = e.currentTarget.getAttribute('data-target');
        currentCard = target;
        // Support quick per-card edit for KPIs and Charts by reusing existing UI
        if(target === 'kpis'){
          // open the centered card edit popover for KPIs (with milestones)
          currentCard = 'kpis';
          cardEditTitle.textContent = 'Edit KPIs & Milestones';
          const executed = document.getElementById('kpi-executed').textContent.replace('%','')||0;
          const passed = document.getElementById('kpi-passed').textContent.replace('%','')||0;
          const defects = document.getElementById('kpi-defects').textContent||0;
          const delay = document.getElementById('kpi-delay').textContent.replace(' days','')||0;
          const m1 = progressChart.data.datasets[1].data[0] || 0;
          const m2 = progressChart.data.datasets[1].data[1] || 0;
          const m3 = progressChart.data.datasets[1].data[2] || 0;
          cardEditBody.innerHTML = `
            <label style="display:block;margin-bottom:8px">Test Cases Executed (%)<input id="kpi_edit_executed" type="number" min="0" max="100" value="${executed}" style="width:100%;padding:6px"></label>
            <label style="display:block;margin-bottom:8px">Test Cases Passed (%)<input id="kpi_edit_passed" type="number" min="0" max="100" value="${passed}" style="width:100%;padding:6px"></label>
            <label style="display:block;margin-bottom:8px">Defects Open<input id="kpi_edit_defects" type="number" min="0" value="${defects}" style="width:100%;padding:6px"></label>
            <label style="display:block;margin-bottom:8px">Delay vs Plan (days)<input id="kpi_edit_delay" type="number" value="${delay}" style="width:100%;padding:6px"></label>
          `;
          openCardPopover();
          return;
        }
        if(target === 'charts'){
          // open the detailed modal editor for charts
          editorModal.style.display = 'flex';
          populateModal();
          return;
        }
        if(target === 'milestones'){
          // open centered popover for milestones only
          currentCard = 'milestones';
          cardEditTitle.textContent = 'Edit Milestones';
          const a1 = progressChart.data.datasets[1].data[0] || 0;
          const a2 = progressChart.data.datasets[1].data[1] || 0;
          const a3 = progressChart.data.datasets[1].data[2] || 0;
          cardEditBody.innerHTML = `
            <label style="display:block;margin-bottom:8px">Test Design %<input id="milestone_m1" type="number" min="0" max="100" value="${a1}" style="width:100%;padding:6px"></label>
            <label style="display:block;margin-bottom:8px">Test Execution %<input id="milestone_m2" type="number" min="0" max="100" value="${a2}" style="width:100%;padding:6px"></label>
            <label style="display:block;margin-bottom:8px">UAT %<input id="milestone_m3" type="number" min="0" max="100" value="${a3}" style="width:100%;padding:6px"></label>
          `;
          openCardPopover();
          return;
        }
        if(target==='blockers'){
          cardEditTitle.textContent = 'Edit Blockers';
          const items = Array.from(document.querySelectorAll('#blockersUl li')).map(li=>{
            const status = li.querySelector('.status').textContent.trim();
            const title = li.querySelector('div > div:first-child').textContent.trim();
            const note = li.querySelector('div > div:last-child').textContent.trim();
            return {status,title,note};
          });
          cardEditBody.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:600">Blockers</div>
              <button id="addBlockerBtn" type="button" style="padding:6px 8px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Add Blocker</button>
            </div>
            <div id="blockerItems">
              ${items.map((it,i)=>`
                <div class="blocker-item" data-index="${i}" style="margin-bottom:8px;border-bottom:1px solid #f1f6fb;padding-bottom:6px">
                  <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600">Item ${i+1}</div><button class="removeBlockerBtn" type="button" style="border:none;background:transparent;color:var(--danger);cursor:pointer">Remove</button></div>
                  <div style="display:flex;gap:8px;margin-top:6px">
                    <select class="c-status"><option>On Track</option><option>Delayed</option><option>Critical</option></select>
                    <input class="c-title" style="flex:1;padding:6px" value="${it.title}">
                  </div>
                  <div style="margin-top:6px"><textarea class="c-note" style="width:100%;height:56px;padding:6px">${it.note}</textarea></div>
                </div>
              `).join('')}
            </div>
            <div style="margin-top:10px;text-align:center">
              <button id="addBlockerBottom" type="button" style="padding:8px 10px;border-radius:6px;border:1px solid #e6edf6;background:#fff;cursor:pointer">Add Blocker</button>
            </div>
          `;
          Array.from(cardEditBody.querySelectorAll('.c-status')).forEach((s,i)=>s.value = items[i].status);
          // wire add/remove inside the popover
          setTimeout(()=>{
            const addBtn = document.getElementById('addBlockerBtn');
            const addBottom = document.getElementById('addBlockerBottom');
            const itemsWrap = document.getElementById('blockerItems');
            function doAdd(defaultTitle='New blocker', defaultNote='Describe the blocker'){
              const idx = itemsWrap.querySelectorAll('.blocker-item').length + 1;
              const div = document.createElement('div');
              div.className = 'blocker-item';
              div.style.marginBottom = '8px'; div.style.borderBottom = '1px solid #f1f6fb'; div.style.paddingBottom = '6px';
              div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600">Item ${idx}</div><button class="removeBlockerBtn" type="button" style="border:none;background:transparent;color:var(--danger);cursor:pointer">Remove</button></div><div style="display:flex;gap:8px;margin-top:6px"><select class="c-status"><option>On Track</option><option>Delayed</option><option>Critical</option></select><input class="c-title" style="flex:1;padding:6px" value="${defaultTitle}"></div><div style="margin-top:6px"><textarea class="c-note" style="width:100%;height:56px;padding:6px">${defaultNote}</textarea></div>`;
              itemsWrap.appendChild(div);
              // attach remove handler
              div.querySelector('.removeBlockerBtn').addEventListener('click', (ev)=>{ if(confirm('Remove this blocker?')){ div.remove(); reorderBlockerTitles(itemsWrap); } });
            }
            if(addBtn){ addBtn.addEventListener('click', ()=> doAdd()); }
            if(addBottom){ addBottom.addEventListener('click', ()=> doAdd()); }
            Array.from(cardEditBody.querySelectorAll('.removeBlockerBtn')).forEach(btn=>btn.addEventListener('click',(ev)=>{ if(confirm('Remove this blocker?')){ ev.currentTarget.closest('.blocker-item').remove(); reorderBlockerTitles(itemsWrap); } }));
          },50);
        }else if(target==='quickfacts'){
          cardEditTitle.textContent = 'Edit Quick Facts';
          const a = document.getElementById('q-active').textContent;
          const ex = document.getElementById('q-exec').textContent;
          const c = document.getElementById('q-critical').textContent;
          cardEditBody.innerHTML = `
            <label style="display:block;margin-bottom:8px">Active testers<input id="cf-active" type="number" value="${a}" style="width:100%;padding:6px"></label>
            <label style="display:block;margin-bottom:8px">Avg execution/day<input id="cf-exec" type="number" value="${ex}" style="width:100%;padding:6px"></label>
            <label style="display:block;margin-bottom:8px">Open critical defects<input id="cf-critical" type="number" value="${c}" style="width:100%;padding:6px"></label>
          `;
        }
        openCardPopover();
      }));
      cardCancelBtn.addEventListener('click', ()=>{ closeCardPopover(); currentCard=null; });
      cardSaveBtn.addEventListener('click', ()=>{
        if(currentCard==='blockers'){
          const blocks = Array.from(cardEditBody.querySelectorAll('.blocker-item'));
          const ul = document.getElementById('blockersUl'); ul.innerHTML='';
          blocks.forEach(b=>{
            const status = b.querySelector('.c-status').value;
            const title = b.querySelector('.c-title').value;
            const note = b.querySelector('.c-note').value;
            const li = document.createElement('li'); li.style.marginBottom='10px'; li.style.display='flex'; li.style.gap='10px'; li.style.alignItems='flex-start';
            const span = document.createElement('span'); span.className='status '+(status==='On Track'?'on':status==='Delayed'?'delayed':'critical'); span.style.minWidth='72px'; span.textContent = status;
            const div = document.createElement('div'); div.innerHTML = `<div style="font-weight:600">${title}</div><div style="color:var(--muted);font-size:13px">${note}</div>`;
            li.appendChild(span); li.appendChild(div); ul.appendChild(li);
          });
          }else if(currentCard==='quickfacts'){
          document.getElementById('q-active').textContent = document.getElementById('cf-active').value;
          document.getElementById('q-exec').textContent = document.getElementById('cf-exec').value;
          document.getElementById('q-critical').textContent = document.getElementById('cf-critical').value;
          }else if(currentCard==='kpis'){
            // read KPI edits from card popover
            const ex = document.getElementById('kpi_edit_executed')?.value || 0;
            const pa = document.getElementById('kpi_edit_passed')?.value || 0;
            const df = document.getElementById('kpi_edit_defects')?.value || 0;
            const dl = document.getElementById('kpi_edit_delay')?.value || 0;
            document.getElementById('kpi-executed').textContent = ex + '%';
            document.getElementById('kpi-passed').textContent = pa + '%';
            document.getElementById('kpi-defects').textContent = df;
            document.getElementById('kpi-delay').textContent = dl + ' days';
            // apply milestone edits
            const m1v = Number(document.getElementById('kpi_edit_m1')?.value || 0);
            const m2v = Number(document.getElementById('kpi_edit_m2')?.value || 0);
            const m3v = Number(document.getElementById('kpi_edit_m3')?.value || 0);
            progressChart.data.datasets[1].data = [m1v,m2v,m3v];
            progressChart.update();
            document.querySelectorAll('.progress-bar')[0].style.width = m1v + '%';
            document.querySelectorAll('.progress-bar')[1].style.width = m2v + '%';
            document.querySelectorAll('.progress-bar')[2].style.width = m3v + '%';
          }else if(currentCard==='milestones'){
            const mm1 = Number(document.getElementById('milestone_m1')?.value || 0);
            const mm2 = Number(document.getElementById('milestone_m2')?.value || 0);
            const mm3 = Number(document.getElementById('milestone_m3')?.value || 0);
            progressChart.data.datasets[1].data = [mm1,mm2,mm3];
            progressChart.update();
            document.querySelectorAll('.progress-bar')[0].style.width = mm1 + '%';
            document.querySelectorAll('.progress-bar')[1].style.width = mm2 + '%';
            document.querySelectorAll('.progress-bar')[2].style.width = mm3 + '%';
          }
        closeCardPopover(); currentCard=null;
        saveState();
      });
    })();

    // helper to re-number item titles after add/remove inside popover
    function reorderBlockerTitles(container){
      const items = container.querySelectorAll('.blocker-item');
      items.forEach((it,idx)=>{
        const title = it.querySelector('div > div:first-child');
        if(title) title.textContent = 'Item ' + (idx+1);
      });
    }
  </script>
</body>
</html>
